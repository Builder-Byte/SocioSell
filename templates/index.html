<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product & Video Listing Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .tab-active {
        background-color: #3b82f6;
        color: white;
      }

      .upload-zone {
        border: 2px dashed #3b82f6;
        transition: all 0.3s ease;
      }

      .upload-zone:hover {
        border-color: #2563eb;
        background-color: rgba(59, 130, 246, 0.05);
      }

      .product-card {
        transition: transform 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-5px);
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .notification {
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="min-h-screen">
      <!-- Navigation -->
      <nav class="bg-white shadow-md fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16 items-center">
            <div class="flex items-center">
              <i class="fas fa-cube text-blue-600 text-2xl"></i>
              <span class="ml-2 text-xl font-semibold">SocioSell</span>
            </div>
            <div class="flex space-x-4">
              <button
                onclick="switchTab('search')"
                id="searchTab"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-search mr-2"></i>Search
              </button>
              <button
                onclick="switchTab('upload')"
                id="uploadTab"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-image mr-2"></i>Image
              </button>
              <button
                onclick="switchTab('video')"
                id="videoTab"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-video mr-2"></i>Video
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="pt-20 pb-8 px-4">
        <div class="max-w-7xl mx-auto">
          <!-- Upload Section -->
          <div id="uploadSection" class="space-y-8">
            <div class="text-center">
              <h1 class="text-3xl font-bold mb-4">Generate Product Listings</h1>
              <p class="text-gray-600">
                Transform your product images into detailed listings
              </p>
            </div>

            <!-- Upload Form -->
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6">
              <div
                class="upload-zone p-8 text-center rounded-lg mb-6"
                id="dropZone"
              >
                <div id="uploadPrompt">
                  <i class="fas fa-image text-4xl text-blue-500 mb-4"></i>
                  <p class="text-gray-600 mb-4">
                    Drag and drop your image here, or
                  </p>
                  <label
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700"
                  >
                    Choose File
                    <input
                      type="file"
                      class="hidden"
                      id="fileInput"
                      accept="image/*"
                      multiple
                    />
                  </label>
                </div>
                <div class="relative">
                  <img id="previewImage" class="hidden max-h-48 mx-auto" />
                  <i
                    class="fa-solid fa-circle-xmark text-red-400 hover:text-red-600 absolute top-2 right-2 hidden"
                    id="removeButton"
                    onclick="removeFile()"
                  ></i>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Product Title</label
                  >
                  <input
                    type="text"
                    id="productTitle"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Caption (optional)</label
                  >
                  <textarea
                    id="caption"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    rows="3"
                  ></textarea>
                </div>
                <button
                  onclick="generateListing()"
                  id="generateBtn"
                  class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700"
                >
                  Generate Listing
                </button>
              </div>
            </div>

            <!-- Generated Listing -->
            <div
              id="generatedListing"
              class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 hidden"
            >
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>

          <!-- Search Section -->
          <div id="searchSection" class="hidden space-y-8">
            <div class="max-w-2xl mx-auto">
              <div class="relative">
                <input
                  type="text"
                  id="searchInput"
                  class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Search products or videos..."
                />
                <i
                  class="fas fa-search absolute left-3 top-3 text-gray-400"
                ></i>
              </div>
            </div>

            <!-- Search Results -->
            <div
              id="searchResults"
              class="grid grid-cols-1 md:grid-cols-3 gap-6"
            >
              <!-- Results will be populated by JavaScript -->
            </div>
          </div>

          <!-- Video Upload Section -->
          <div id="videoSection" class="hidden space-y-8">
            <div class="text-center">
              <h1 class="text-3xl font-bold mb-4">Generate Video Listings</h1>
              <p class="text-gray-600">
                Transform your product videos into detailed listings
              </p>
            </div>

            <!-- Video Upload Form -->
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6">
              <div
                class="upload-zone p-8 text-center rounded-lg mb-6"
                id="videoDropZone"
              >
                <div id="videoUploadPrompt">
                  <i class="fas fa-video text-4xl text-blue-500 mb-4"></i>
                  <p class="text-gray-600 mb-4">
                    Drag and drop your video here, or
                  </p>
                  <label
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700"
                  >
                    Choose Video
                    <input
                      type="file"
                      class="hidden"
                      id="videoInput"
                      accept="video/*"
                    />
                  </label>
                </div>

                <div class="relative">
                  <video
                    id="previewVideo"
                    class="hidden max-h-48 mx-auto"
                    controls
                  ></video>

                  <i
                    class="fa-solid fa-circle-xmark text-red-400 hover:text-red-600 absolute top-2 right-2 hidden"
                    id="removeVideoButton"
                    onclick="removeVideoFile()"
                  ></i>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Video Title</label
                  >
                  <input
                    type="text"
                    id="videoTitle"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Description (optional)</label
                  >
                  <textarea
                    id="videoDescription"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    rows="3"
                  ></textarea>
                </div>
                <button
                  onclick="generateVideoListing()"
                  id="generateVideoBtn"
                  class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700"
                >
                  Generate Video Listing
                </button>
              </div>
            </div>

            <!-- Generated Video Listing -->
            <div
              id="generatedVideoListing"
              class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 hidden"
            >
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </main>

      <!-- Notification -->
      <div id="notification" class="fixed bottom-4 right-4 hidden notification">
        <div
          class="bg-white rounded-lg shadow-lg p-4 flex items-center space-x-3"
        >
          <i class="fas fa-check-circle text-green-500 text-xl"></i>
          <p id="notificationText" class="text-gray-700"></p>
        </div>
      </div>
    </div>

    <script>
      // Global state
      let currentTab = "upload";
      let uploadedFile = null;
      let uploadedVideo = null;

      // Event Listeners
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileSelect);
      document
        .getElementById("videoInput")
        .addEventListener("change", handleVideoSelect);
      document
        .getElementById("dropZone")
        .addEventListener("dragover", handleDragOver);
      document.getElementById("dropZone").addEventListener("drop", handleDrop);
      document
        .getElementById("videoDropZone")
        .addEventListener("dragover", handleDragOver);
      document
        .getElementById("videoDropZone")
        .addEventListener("drop", handleVideoDrop);
      document
        .getElementById("searchInput")
        .addEventListener("keyup", function (e) {
          if (e.key === "Enter") searchAll();
        });

      // Tab Switching
      function switchTab(tab) {
        currentTab = tab;
        document
          .getElementById("uploadSection")
          .classList.toggle("hidden", tab !== "upload");
        document
          .getElementById("searchSection")
          .classList.toggle("hidden", tab !== "search");
        document
          .getElementById("videoSection")
          .classList.toggle("hidden", tab !== "video");
        document
          .getElementById("uploadTab")
          .classList.toggle("tab-active", tab === "upload");
        document
          .getElementById("searchTab")
          .classList.toggle("tab-active", tab === "search");
        document
          .getElementById("videoTab")
          .classList.toggle("tab-active", tab === "video");
      }

      // File Handling
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileSelect);

      function handleFileSelect(e) {
        const file = e.target.files[0]; // Get the first file
        if (file) {
          displayPreview(file);
        } else {
          console.error("No file selected or file is invalid");
        }
      }

      function handleVideoSelect(e) {
        const file = e.target.files[0];
        if (file) displayVideoPreview(file);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add("border-blue-600");
      }

      function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("border-blue-600");
        const file = e.dataTransfer.files[0];
        if (file) displayPreview(file);
      }

      function handleVideoDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("border-blue-600");
        const file = e.dataTransfer.files[0];
        if (file) displayVideoPreview(file);
      }

      function displayPreview(file) {
        if (!file || !(file instanceof Blob)) {
          console.error("Invalid file object:", file);
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById("previewImage");
          preview.src = e.target.result;
          preview.classList.remove("hidden");
          document.getElementById("uploadPrompt").classList.add("hidden");
          document.getElementById("removeButton").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }

      function displayVideoPreview(file) {
        uploadedVideo = file;
        const preview = document.getElementById("previewVideo");
        preview.src = URL.createObjectURL(file);
        preview.classList.remove("hidden");
        document.getElementById("videoUploadPrompt").classList.add("hidden");
        document.getElementById("removeVideoButton").classList.remove("hidden");
      }

      function removeFile() {
        document.getElementById("fileInput").value = "";
        document.getElementById("previewImage").src = "";
        document.getElementById("previewImage").classList.add("hidden");
        document.getElementById("removeButton").classList.add("hidden");
        document.getElementById("uploadPrompt").classList.remove("hidden");
      }

      function removeVideoFile() {
        document.getElementById("videoInput").value = "";
        document.getElementById("previewVideo").src = "";
        document.getElementById("previewVideo").classList.add("hidden");
        document.getElementById("removeVideoButton").classList.add("hidden");
        document.getElementById("videoUploadPrompt").classList.remove("hidden");
      }

      // Generate Listings
      async function generateListing() {
        const title = document.getElementById("productTitle").value;
        const files = document.getElementById("fileInput").files;

        if (!files || files.length === 0 || !title) {
          showNotification("Please provide both image(s) and title", "error");
          return;
        }

        const btn = document.getElementById("generateBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i class="fas fa-spinner spinner mr-2"></i>Generating...';

        const formData = new FormData();
        formData.append("title", title);
        formData.append("caption", document.getElementById("caption").value);

        // Append all files to FormData
        Array.from(files).forEach((file, index) => {
          formData.append("files", file); // Use "files" to match the backend parameter
        });

        try {
          const response = await fetch("/upload/image/", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            // If the response is not OK, log the error details
            const errorData = await response.json();
            console.error("Error details:", errorData);
            throw new Error(errorData.detail || "Failed to generate listing");
          }

          const data = await response.json();

          if (data.status === "success") {
            displayGeneratedListing(data.listing);
            showNotification("Listing generated successfully!");
          } else {
            throw new Error(data.message || "Failed to generate listing");
          }
        } catch (error) {
          console.error("Error generating listing:", error); // Log the full error
          showNotification(`Error: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Generate Listing";
        }
      }

      // Update the generateVideoListing function
      async function generateVideoListing() {
        const title = document.getElementById("videoTitle").value;
        const description = document.getElementById("videoDescription").value;

        if (!title) {
          showNotification("Please provide a video title", "error");
          return;
        }

        const btn = document.getElementById("generateVideoBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i class="fas fa-spinner spinner mr-2"></i>Generating...';

        try {
          // Create the request body
          const formData = new FormData();
          formData.append("title", title);
          formData.append("description", description || "");

          // Only append file if it exists
          if (uploadedVideo) {
            formData.append("file", uploadedVideo);
          }

          const response = await fetch("/upload/video/", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log(data);

          if (
            data.status === "success" &&
            data.message === "Video processed successfully" &&
            data.product_info
          ) {
            // Add default values for any missing properties
            const processedData = {
              id: data.product_info.id || `video_${Date.now()}`,
              title: data.product_info.title || title,
              transcript_summary:
                data.product_info.transcript_summary ||
                description ||
                "No description provided",
              highlights: data.product_info.highlights || [
                "Video analysis in progress",
              ],
              key_features: data.product_info.key_features || [
                "Features being analyzed",
              ],
              analytics: {
                views: data.product_info.analytics?.views || "0",
                likes: data.product_info.analytics?.likes || "0",
                engagement_rate:
                  data.product_info.analytics?.engagement_rate || "0%",
              },
              platforms: data.product_info.platforms || [
                { name: "YouTube", views: "0", rating: "0" },
                { name: "TikTok", views: "0", rating: "0" },
              ],
              category: data.product_info.category || "electronics",
              duration: data.product_info.duration || "0:00",
            };

            displayGeneratedVideoListing(processedData);
            showNotification("Video listing generated successfully!");
          } else {
            throw new Error(data.message || "Failed to process video");
          }
        } catch (error) {
          console.error("Error generating video listing:", error);
          showNotification(`Error: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Generate Video Listing";
        }
      }

      async function getVideoAnalytics(videoId) {
        try {
          const response = await fetch(`/video/analytics/${videoId}`);
          const data = await response.json();

          const analyticsSection = document.getElementById(
            "videoAnalyticsSection"
          );
          if (!analyticsSection) return;

          if (data.status === "success" && data.analytics) {
            analyticsSection.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Video Analytics</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="font-semibold mb-3">Engagement</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Views</span>
                                <span>${data.analytics.engagement.views}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Likes</span>
                                <span>${data.analytics.engagement.likes}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Comments</span>
                                <span>${
                                  data.analytics.engagement.comments
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Watch Time</span>
                                <span>${
                                  data.analytics.engagement.average_watch_time
                                }</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="font-semibold mb-3">Performance</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Retention Rate</span>
                                <span>${
                                  data.analytics.performance.retention_rate
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">CTR</span>
                                <span>${
                                  data.analytics.performance.click_through_rate
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Conversion Rate</span>
                                <span>${
                                  data.analytics.performance.conversion_rate
                                }</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="font-semibold mb-3">Demographics</h4>
                        <div class="space-y-2">
                            ${Object.entries(
                              data.analytics.audience.demographics
                            )
                              .map(
                                ([age, percentage]) => `
                                <div class="flex justify-between">
                                    <span class="text-gray-600">${age}</span>
                                    <span>${percentage}</span>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <h5 class="font-semibold mt-4 mb-2">Top Regions</h5>
                        <div class="flex flex-wrap gap-2">
                            ${data.analytics.audience.top_regions
                              .map(
                                (region) => `
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${region}</span>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                </div>
            `;
          }
        } catch (error) {
          console.error("Error loading video analytics:", error);
          showNotification("Error loading video analytics", "error");
        }
      }

      function displayGeneratedListing(listing) {
        const container = document.getElementById("generatedListing");
        const previewImage = document.getElementById("previewImage");

        if (!previewImage) {
          console.error("previewImage element not found");
          return;
        }

        // Ensure the previewImage has a valid src
        if (!previewImage.src) {
          console.error("previewImage.src is undefined or empty");
          return;
        }

        // Update the container with the generated listing details
        container.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div>
        <img src="${
          previewImage.src
        }" class="w-full rounded-lg mb-4 object-cover h-[300px]">
        <h2 class="text-2xl font-bold mb-2">${listing.title}</h2>
        <p class="text-gray-600 mb-4">${listing.description}</p>
        <div class="text-2xl font-bold text-blue-600 mb-4">${
          listing.price
        }</div>
      </div>
      <div class="space-y-6">
        <div>
          <h3 class="text-xl font-semibold mb-4">Features</h3>
          <div class="space-y-3">
            ${listing.features
              .map(
                (feature) => `
              <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-700">${feature}</span>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
        <div class="flex space-x-4 pt-4">
          <button onclick="getComparisons('${listing.product_id}')" 
                  class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300">
            <i class="fas fa-sync-alt mr-2"></i>Compare
          </button>
          <button onclick="getAnalytics('${listing.product_id}')"
                  class="flex-1 border border-blue-600 text-blue-600 py-3 px-6 rounded-lg hover:bg-blue-50 transition-all duration-300">
            <i class="fas fa-chart-line mr-2"></i>Analytics
          </button>
        </div>
      </div>
    </div>
    <div id="comparisonsSection" class="mt-8 hidden">
      <h3 class="text-xl font-semibold mb-4">Compare with Similar Products</h3>
      <div id="comparisonsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>
    <div id="analyticsSection" class="mt-8 hidden">
      <h3 class="text-xl font-semibold mb-4">Product Analytics</h3>
      <div id="analyticsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>
  `;

        // Show the generated listing container
        container.classList.remove("hidden");
        container.scrollIntoView({ behavior: "smooth" });
      }

      async function getComparisons(productId) {
        try {
          const comparisonsSection =
            document.getElementById("comparisonsSection");
          comparisonsSection.classList.remove("hidden");
          const comparisonsGrid = document.getElementById("comparisonsGrid");
          comparisonsGrid.innerHTML =
            '<div class="col-span-3 text-center"><i class="fas fa-spinner spinner text-blue-600 text-3xl"></i></div>';

          const response = await fetch(`/compare/${productId}`);
          const data = await response.json();

          if (
            data.status === "success" &&
            data.comparable_products &&
            data.comparable_products.length > 0
          ) {
            comparisonsGrid.innerHTML = `
                <div class="col-span-3 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Features</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.comparable_products
                              .map(
                                (product) => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center space-x-3">
                                            <img src="${getProductImage(
                                              product.id
                                            )}" 
                                                alt="${product.name}"
                                                class="w-12 h-12 rounded-lg object-cover">
                                            <div class="font-medium text-gray-900">${
                                              product.name
                                            }</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-blue-600 font-medium">${
                                          product.price_range
                                        }</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <ul class="list-none space-y-1">
                                            ${product.features
                                              .map(
                                                (feature) => `
                                                <li class="flex items-center space-x-2">
                                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    <span class="text-sm text-gray-600">${feature}</span>
                                                </li>
                                            `
                                              )
                                              .join("")}
                                        </ul>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button onclick="viewProduct('${
                                          product.id
                                        }')" 
                                                class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition-all duration-300">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;
          } else {
            comparisonsGrid.innerHTML = `
                <div class="col-span-3 text-center py-8">
                    <i class="fas fa-info-circle text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500">No comparable products found</p>
                </div>
            `;
          }
          comparisonsSection.scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error loading comparisons:", error);
          showNotification("Error loading comparisons", "error");
        }
      }

      async function getAnalytics(productId) {
        try {
          const analyticsSection = document.getElementById("analyticsSection");
          analyticsSection.classList.remove("hidden");
          const analyticsGrid = document.getElementById("analyticsGrid");
          analyticsGrid.innerHTML =
            '<div class="col-span-3 text-center"><i class="fas fa-spinner spinner text-blue-600 text-3xl"></i></div>';

          const response = await fetch(`/product/analytics/${productId}`);
          const data = await response.json();

          if (data.status === "success" && data.analytics) {
            analyticsGrid.innerHTML = `
                <div class="col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Sales Performance -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Sales Performance</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Sales</span>
                                <span class="font-medium">${
                                  data.analytics.sales_performance.total_sales
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Revenue</span>
                                <span class="font-medium">${
                                  data.analytics.sales_performance.revenue
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Growth Rate</span>
                                <span class="font-medium">${
                                  data.analytics.sales_performance.growth_rate
                                }</span>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Behavior -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Customer Behavior</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">View to Purchase Rate</span>
                                <span class="font-medium">${
                                  data.analytics.customer_behavior
                                    .view_to_purchase_rate
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Cart Abandonment</span>
                                <span class="font-medium">${
                                  data.analytics.customer_behavior
                                    .cart_abandonment_rate
                                }</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Rating</span>
                                <span class="font-medium">${
                                  data.analytics.customer_behavior
                                    .average_rating
                                }</span>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Demographics</h4>
                        <div class="space-y-3">
                            ${Object.entries(
                              data.analytics.demographics.age_groups
                            )
                              .map(
                                ([age, percentage]) => `
                                <div class="flex justify-between">
                                    <span class="text-gray-600">${age}</span>
                                    <span class="font-medium">${percentage}</span>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>

                    <!-- Marketing Metrics -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Marketing Metrics</h4>
                        <div class="space-y-3">
                            ${Object.entries(data.analytics.marketing_metrics)
                              .map(
                                ([metric, value]) => `
                                <div class="flex justify-between">
                                    <span class="text-gray-600">${metric
                                      .split("_")
                                      .map(
                                        (word) =>
                                          word.charAt(0).toUpperCase() +
                                          word.slice(1)
                                      )
                                      .join(" ")}</span>
                                    <span class="font-medium">${value}</span>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                </div>
            `;
          } else {
            analyticsGrid.innerHTML = `
                <div class="col-span-3 text-center py-8">
                    <i class="fas fa-chart-bar text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500">No analytics data available</p>
                </div>
            `;
          }
          analyticsSection.scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error loading analytics:", error);
          showNotification("Error loading analytics", "error");
        }
      }

      // Update the displayGeneratedVideoListing function to handle missing properties
      function displayGeneratedVideoListing(videoInfo) {
        const container = document.getElementById("generatedVideoListing");
        container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                ${
                  uploadedVideo
                    ? `<video src="${
                        document.getElementById("previewVideo").src
                      }" 
                            class="w-full rounded-lg mb-4 object-cover" 
                            controls></video>`
                    : `<div class="w-full h-[300px] bg-gray-100 rounded-lg mb-4 flex items-center justify-center">
                        <i class="fas fa-video text-gray-400 text-4xl"></i>
                     </div>`
                }
                <h2 class="text-2xl font-bold mb-2">${videoInfo.title}</h2>
                <p class="text-gray-600 mb-4">${
                  videoInfo.transcript_summary
                }</p>
                <div class="flex items-center space-x-4 mb-4">
                    <span class="text-gray-500"><i class="fas fa-eye mr-1"></i>${
                      videoInfo.analytics.views
                    }</span>
                    <span class="text-gray-500"><i class="fas fa-thumbs-up mr-1"></i>${
                      videoInfo.analytics.likes
                    }</span>
                    <span class="text-gray-500"><i class="fas fa-chart-line mr-1"></i>${
                      videoInfo.analytics.engagement_rate
                    }</span>
                </div>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-semibold mb-4">Highlights</h3>
                    <div class="space-y-3">
                        ${videoInfo.highlights
                          .map(
                            (highlight) => `
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <span class="text-gray-700">${highlight}</span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Key Features</h3>
                    <div class="space-y-3">
                        ${videoInfo.key_features
                          .map(
                            (feature) => `
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <span class="text-gray-700">${feature}</span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Platforms</h3>
                    <div class="grid grid-cols-2 gap-4">
                        ${videoInfo.platforms
                          .map(
                            (platform) => `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium mb-2">${platform.name}</h4>
                                <div class="text-sm text-gray-600">
                                    <div>Views: ${platform.views}</div>
                                    <div>Rating: ${platform.rating}</div>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button onclick="getVideoComparisons('${videoInfo.id}')" 
                            class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300">
                        <i class="fas fa-sync-alt mr-2"></i>Compare
                    </button>
                    <button onclick="getVideoAnalytics('${videoInfo.id}')"
                            class="flex-1 border border-blue-600 text-blue-600 py-3 px-6 rounded-lg hover:bg-blue-50 transition-all duration-300">
                        <i class="fas fa-chart-line mr-2"></i>Analytics
                    </button>
                </div>
            </div>
        </div>
        <div id="videoAnalyticsSection" class="mt-8">
            <!-- Analytics content will be loaded here -->
        </div>
        <div id="videoComparisonsSection" class="mt-8 hidden">
            <h3 class="text-xl font-semibold mb-4">Compare with Similar Videos</h3>
            <div id="videoComparisonsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>
    `;
        container.classList.remove("hidden");
        container.scrollIntoView({ behavior: "smooth" });

        // Automatically load analytics
        if (videoInfo.id) {
          getVideoAnalytics(videoInfo.id);
        }
      }
      // Add video comparison function
      async function getVideoComparisons(videoId) {
        try {
          const comparisonsSection = document.getElementById(
            "videoComparisonsSection"
          );
          comparisonsSection.classList.remove("hidden");
          const comparisonsGrid = document.getElementById(
            "videoComparisonsGrid"
          );
          comparisonsGrid.innerHTML =
            '<div class="col-span-3 text-center"><i class="fas fa-spinner spinner text-blue-600 text-3xl"></i></div>';

          const response = await fetch(`/video/compare/${videoId}`);
          const data = await response.json();

          if (
            data.status === "success" &&
            data.comparable_videos &&
            data.comparable_videos.length > 0
          ) {
            comparisonsGrid.innerHTML = data.comparable_videos
              .map(
                (video) => `
                <div class="bg-white rounded-lg shadow-md p-6 space-y-4">
                    <div class="relative">
                        <div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-play-circle text-gray-400 text-4xl"></i>
                        </div>
                        <span class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm">
                            ${video.duration}
                        </span>
                    </div>
                    <div>
                        <h4 class="font-semibold">${video.title}</h4>
                        <p class="text-sm text-gray-500">${
                          video.views
                        } views</p>
                    </div>
                    <div class="space-y-2">
                        <h5 class="font-medium">Comparison Points</h5>
                        <ul class="space-y-1">
                            ${video.comparison_points
                              .map(
                                (point) => `
                                <li class="flex items-center space-x-2 text-sm">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>${point}</span>
                                </li>
                            `
                              )
                              .join("")}
                        </ul>
                    </div>
                    <div class="pt-2">
                        <span class="text-blue-600 font-medium">${
                          video.price_range
                        }</span>
                    </div>
                    <button onclick="viewVideo('${video.id}')"
                            class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg hover:bg-blue-100 transition-all duration-300">
                        View Details
                    </button>
                </div>
            `
              )
              .join("");
          } else {
            comparisonsGrid.innerHTML = `
                <div class="col-span-3 text-center py-8">
                    <i class="fas fa-info-circle text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500">No comparable videos found</p>
                </div>
            `;
          }
          comparisonsSection.scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error loading video comparisons:", error);
          showNotification("Error loading video comparisons", "error");
        }
      }

      // Add view video function
      async function viewVideo(videoId) {
        try {
          const response = await fetch(`/video/listings/${videoId}`);
          const data = await response.json();

          if (data.status === "success" && data.listings.length > 0) {
            const videoInfo = data.listings[0];
            displayGeneratedVideoListing({
              id: videoId,
              title: videoInfo.title,
              transcript_summary:
                videoInfo.description || "No description available",
              analytics: {
                views: videoInfo.views,
                likes: "—",
                engagement_rate: "—",
              },
              highlights: videoInfo.key_timestamps
                ? Object.entries(videoInfo.key_timestamps).map(
                    ([key, value]) => `${key}: ${value}`
                  )
                : ["No highlights available"],
              key_features: ["Feature information not available"],
              platforms: videoInfo.product_links.map((link) => ({
                name: link.store,
                views: "—",
                rating: "—",
              })),
            });
          } else {
            showNotification("Video not found", "error");
          }
        } catch (error) {
          console.error("Error loading video:", error);
          showNotification("Error loading video details", "error");
        }
      }

      async function searchAll() {
        const query = document.getElementById("searchInput").value;
        if (!query) return;

        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML =
          '<div class="col-span-3 text-center"><i class="fas fa-spinner spinner text-blue-600 text-3xl"></i></div>';

        try {
          const response = await fetch(
            `/search/all/${encodeURIComponent(query)}`
          );
          const data = await response.json();

          if (
            data.status === "success" &&
            (data.results.products.length > 0 || data.results.videos.length > 0)
          ) {
            let html = "";

            // Products section
            if (data.results.products.length > 0) {
              html += `
                            <div class="col-span-3">
                                <h2 class="text-xl font-semibold mb-4">Products</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        `;
              html += data.results.products
                .map(
                  (product) => `
                            <div class="product-card bg-white rounded-xl shadow-md p-4 cursor-pointer"
                                 onclick="viewProduct('${product.id}')">
                                <img src="${getProductImage(product.id)}" 
                                     alt="${product.title}"
                                     class="w-full h-48 object-cover rounded-lg mb-4">
                                <h3 class="font-semibold mb-2">${
                                  product.title
                                }</h3>
                                <p class="text-sm text-gray-500 mb-2">${
                                  product.category
                                }</p>
                                <p class="text-blue-600 font-semibold">${
                                  product.price_range
                                }</p>
                            </div>
                        `
                )
                .join("");
              html += "</div></div>";
            }

            // Videos section
            if (data.results.videos.length > 0) {
              html += `
                            <div class="col-span-3 mt-8">
                                <h2 class="text-xl font-semibold mb-4">Videos</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        `;
              html += data.results.videos
                .map(
                  (video) => `
                            <div class="product-card bg-white rounded-xl shadow-md p-4 cursor-pointer"
                                 onclick="viewVideo('${video.id}')">
                                <div class="relative">
                                    <img src="/api/placeholder/400/225" 
                                         alt="${video.title}"
                                         class="w-full h-48 object-cover rounded-lg mb-4">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas fa-play-circle text-white text-4xl opacity-75"></i>
                                    </div>
                                </div>
                                <h3 class="font-semibold mb-2">${video.title}</h3>
                                <p class="text-sm text-gray-500 mb-2">${video.category}</p>
                                <div class="flex items-center space-x-4">
                                    <span class="text-gray-500 text-sm"><i class="fas fa-eye mr-1"></i>${video.analytics.views}</span>
                                    <span class="text-gray-500 text-sm"><i class="fas fa-thumbs-up mr-1"></i>${video.analytics.likes}</span>
                                </div>
                            </div>
                        `
                )
                .join("");
              html += "</div></div>";
            }

            resultsContainer.innerHTML = html;
          } else {
            resultsContainer.innerHTML = `
                        <div class="col-span-3 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-2"></i>
                            <p>No results found</p>
                        </div>
                    `;
          }
        } catch (error) {
          showNotification("Error searching content", "error");
        }
      }

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const text = document.getElementById("notificationText");
        text.textContent = message;
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 3000);
      }

      // Initialize
      switchTab("upload");

      // Product image mapping
      const PRODUCT_ID_MAPPING = {
        headphones: "elec_123",
        shoes: "fash_123",
        lamp: "decor_123",
        lipstick: "beauty_123",
        basketball: "sports_123",
      };

      const PRODUCT_IMAGES = {
        electronics: {
          elec_123: "/static/electronics/sony_headphones.jpg",
          elec_124: "/static/electronics/smart_watch.webp",
          elec_125: "/static/electronics/apple_ipad.jpg",
        },
        fashion: {
          fash_123: "/static/fashion/nike_shoes.jpg",
          fash_124: "/static/fashion/oversized_zara_blazer.jpg",
          fash_125: "/static/fashion/adidas_shoes.webp",
        },
        home_decor: {
          decor_123: "/static/home_decor/lamp.jpeg",
          decor_124: "/static/home_decor/rug.jpeg",
          decor_125: "/static/home_decor/mirror.jpg",
        },
        beauty: {
          beauty_123: "/static/beauty/lipstick.jpg",
          beauty_124: "/static/beauty/mascara.avif",
          beauty_125: "/static/beauty/foundation.jpg",
        },
        sports: {
          sports_123: "/static/sports/basketball.jpeg",
          sports_124: "/static/sports/cleats.jpeg",
          sports_125: "/static/sports/racket.webp",
        },
      };

      function getProductImage(productId) {
        for (const category of Object.values(PRODUCT_IMAGES)) {
          if (productId in category) {
            return category[productId];
          }
        }
        return "/static/placeholder.png";
      }
    </script>
  </body>
</html>
